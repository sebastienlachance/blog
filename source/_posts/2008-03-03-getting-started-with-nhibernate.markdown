---
layout: post
title: "Getting started with NHibernate"
date: 2008-03-03 10:48:00
comments: true
categories: 
---

<p>Without digging in too much detail about NHibernate, I will presume you are familiar with what this O/R Mapper can do.</p>
<p><span style="text-decoration: underline;"><strong>The application configuration file :</strong> </span></p>
<div>
<pre style="border-style: none; margin: 0pt; padding: 0pt; overflow: visible; font-size: 8pt; width: 100%; color: black; line-height: 12pt; font-family: consolas,'Courier New',courier,monospace; background-color: #f4f4f4;"><span style="color: #0000ff;">&lt;?</span><span style="color: #800000;">xml</span> <span style="color: #ff0000;">version</span><span style="color: #0000ff;">="1.0"</span> <span style="color: #ff0000;">encoding</span><span style="color: #0000ff;">="utf-8"</span> ?<span style="color: #0000ff;">&gt;</span><br /><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span><br />  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">configSections</span><span style="color: #0000ff;">&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">section</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="hibernate-configuration"</span> <span style="color: #ff0000;">type</span><span style="color: #0000ff;">="NHibernate.Cfg.ConfigurationSectionHandler, NHibernate"</span> <span style="color: #0000ff;">/&gt;</span><br />  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">configSections</span><span style="color: #0000ff;">&gt;</span><br />  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">hibernate-configuration</span> <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="urn:nhibernate-configuration-2.2"</span><span style="color: #0000ff;">&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">session-factory</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="connection.driver_class"</span><span style="color: #0000ff;">&gt;</span>NHibernate.Driver.SqlClientDriver<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="hibernate.dialect"</span><span style="color: #0000ff;">&gt;</span>NHibernate.Dialect.MsSql2005Dialect<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="hibernate.connection.provider"</span><span style="color: #0000ff;">&gt;</span>NHibernate.Connection.DriverConnectionProvider<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="hibernate.connection.connection_string"</span><span style="color: #0000ff;">&gt;</span>Server=.SQLEXPRESS;Initial Catalog=RecipeHelperTest;User Id=recipeuser;Password=recipeuser;<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">property</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">mapping</span> <span style="color: #ff0000;">assembly</span><span style="color: #0000ff;">="RecipeHelper.Domain"</span> <span style="color: #0000ff;">/&gt;</span><br />    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">session-factory</span><span style="color: #0000ff;">&gt;</span><br />  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">hibernate-configuration</span><span style="color: #0000ff;">&gt;</span><br /><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">configuration</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<p>This is standard stuff that you can find in the documentation. One interesting point however is the mapping. You can specify where your domain object to be persisted are. This will allow you to not worry about specifying them in code.</p>
<p><span style="text-decoration: underline;"><strong>Creating a mapping file :</strong></span></p>
<p>To be able to persist your entities, you'll need to create a mapping file. In my opinion, this is the hardest thing to learn about NHibernate. But don't worry, it is well documented.</p>
<p>The strategy I am using is one file per entities, in the same assembly. I also use the same name with the extension ".hbm.xml". The trickiest part is that you need to set the <strong>Build Action</strong> to "<strong>Embedded Resource</strong>". Once all this is completed you can now start writing your mapping information :</p>
<div>
<pre style="border-style: none; margin: 0pt; padding: 0pt; overflow: visible; font-size: 8pt; width: 100%; color: black; line-height: 12pt; font-family: consolas,'Courier New',courier,monospace; background-color: #f4f4f4;"><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">hibernate-mapping</span> <span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="urn:nhibernate-mapping-2.2"</span> <span style="color: #ff0000;">assembly</span><span style="color: #0000ff;">="RecipeHelper.Domain"</span> <span style="color: #ff0000;">namespace</span><span style="color: #0000ff;">="RecipeHelper.Domain"</span> <span style="color: #ff0000;">default-lazy</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">&gt;</span><br />  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">class</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Recipe"</span> <span style="color: #ff0000;">table</span><span style="color: #0000ff;">="Recipes"</span> <span style="color: #0000ff;">&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">id</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="ID"</span> <span style="color: #ff0000;">column</span><span style="color: #0000ff;">="ID"</span> <span style="color: #ff0000;">type</span><span style="color: #0000ff;">="int"</span> <span style="color: #ff0000;">access</span><span style="color: #0000ff;">="field.lowercase-underscore"</span><span style="color: #0000ff;">&gt;</span><br />      <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">generator</span> <span style="color: #ff0000;">class</span><span style="color: #0000ff;">="native"</span> <span style="color: #0000ff;">/&gt;</span><br />    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">id</span><span style="color: #0000ff;">&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Name"</span> <span style="color: #ff0000;">column</span><span style="color: #0000ff;">="Name"</span> <span style="color: #ff0000;">type</span><span style="color: #0000ff;">="string"</span> <span style="color: #ff0000;">not-null</span><span style="color: #0000ff;">="false"</span><span style="color: #0000ff;">/&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Reference"</span> <span style="color: #ff0000;">column</span><span style="color: #0000ff;">="Reference"</span> <span style="color: #ff0000;">type</span><span style="color: #0000ff;">="string"</span> <span style="color: #ff0000;">not-null</span><span style="color: #0000ff;">="false"</span> <span style="color: #0000ff;">/&gt;</span><br />    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property</span> <span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Rating"</span> <span style="color: #ff0000;">column</span><span style="color: #0000ff;">="Rating"</span> <span style="color: #ff0000;">type</span><span style="color: #0000ff;">="int"</span> <span style="color: #ff0000;">not-null</span><span style="color: #0000ff;">="false"</span> <span style="color: #0000ff;">/&gt;</span><br />  <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">class</span><span style="color: #0000ff;">&gt;</span><br /><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">hibernate-mapping</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<p><span style="text-decoration: underline;"><strong>Preparation for using NHibernate :</strong></span></p>
<p>The biggest performance hit is the creation of the ISessionFactory. For this reason, it should only be instantiated once. I created a singleton that will allow me to have access to a single session factory.</p>
<div>
<pre style="border-style: none; margin: 0pt; padding: 0pt; overflow: visible; font-size: 8pt; width: 100%; color: black; line-height: 12pt; font-family: consolas,'Courier New',courier,monospace; background-color: #f4f4f4;"><span style="color: #0000ff;">using</span> NHibernate;<br /><span style="color: #0000ff;">using</span> NHibernate.Cfg;<br /><span style="color: #0000ff;">using</span> NHibernate.Tool.hbm2ddl;<br /><br /><span style="color: #0000ff;">namespace</span> RecipeHelper.Domain<br />{<br />    <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> NHibernateConfig<br />    {<br />        <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> ISessionFactory _sessionFactory;<br /><br />        <span style="color: #0000ff;">static</span> NHibernateConfig()<br />        {<br />            Configuration config = <span style="color: #0000ff;">new</span> Configuration();<br /><br />            _sessionFactory = config.Configure().BuildSessionFactory();<br />        }<br /><br />        <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> ISessionFactory GetSessionFactory()<br />        {<br />            <span style="color: #0000ff;">return</span> _sessionFactory;<br />        }<br /><br />    }<br />}</pre>
</div>
<p><strong><span style="text-decoration: underline;">Conclusion : </span></strong></p>
<p>This isn't a complete tutorial to get started with NHibernate but should cover the essential steps to prepare your project to use it.</p>